import{d as ee,S as N,aa as le,r as B,k as K,z as V,C as ze,a as i,c as ne,a2 as ae,$ as Y,ah as Oe,O as te,E as fe,ai as pe,m as M,t as p,x as E,Q as re,a0 as ge,B as Te,X as ie,W as _,aj as De,ak as Ue,D as he,H as Fe,I as W,al as we,ae as Le,R as J,w as be,am as ye,an as Ae,Z as Be,ao as Ce,ap as Xe,V as Ye,K as ce,L as ue,aq as Ze}from"./index-DzMYebL8.js";import{b as Me,u as se,a as Ee,P as Ve,S as $e,m as je,c as He}from"./mount-component-D_Vrcc0x.js";import{I as Ie}from"./index-BzJzyR4g.js";import{L as Pe}from"./index-Cb44ZhR3.js";const de=e=>Math.sqrt((e[0].clientX-e[1].clientX)**2+(e[0].clientY-e[1].clientY)**2),Ne=e=>({x:(e[0].clientX+e[1].clientX)/2,y:(e[0].clientY+e[1].clientY)/2}),oe=ne("image-preview")[1],ve=2.6,_e={src:String,show:Boolean,active:Number,minZoom:N(te),maxZoom:N(te),rootWidth:N(Number),rootHeight:N(Number),disableZoom:Boolean,doubleScale:Boolean,closeOnClickImage:Boolean,closeOnClickOverlay:Boolean,vertical:Boolean};var We=ee({props:_e,emits:["scale","close","longPress"],setup(e,{emit:l,slots:u}){const a=le({scale:1,moveX:0,moveY:0,moving:!1,zooming:!1,initializing:!1,imageRatio:0}),m=Me(),d=B(),k=B(),C=B(!1),y=B(!1);let R=0;const s=K(()=>{const{scale:o,moveX:n,moveY:c,moving:P,zooming:O,initializing:A}=a,G={transitionDuration:O||P||A?"0s":".3s"};return(o!==1||y.value)&&(G.transform=`matrix(${o}, 0, 0, ${o}, ${n}, ${c})`),G}),f=K(()=>{if(a.imageRatio){const{rootWidth:o,rootHeight:n}=e,c=C.value?n/a.imageRatio:o;return Math.max(0,(a.scale*c-o)/2)}return 0}),g=K(()=>{if(a.imageRatio){const{rootWidth:o,rootHeight:n}=e,c=C.value?n:o*a.imageRatio;return Math.max(0,(a.scale*c-n)/2)}return 0}),h=(o,n)=>{var c;if(o=Y(o,+e.minZoom,+e.maxZoom+1),o!==a.scale){const P=o/a.scale;if(a.scale=o,n){const O=fe((c=d.value)==null?void 0:c.$el),A={x:O.width*.5,y:O.height*.5},G=a.moveX-(n.x-O.left-A.x)*(P-1),Re=a.moveY-(n.y-O.top-A.y)*(P-1);a.moveX=Y(G,-f.value,f.value),a.moveY=Y(Re,-g.value,g.value)}else a.moveX=0,a.moveY=y.value?R:0;l("scale",{scale:o,index:e.active})}},x=()=>{h(1)},$=()=>{const o=a.scale>1?1:2;h(o,o===2||y.value?{x:m.startX.value,y:m.startY.value}:void 0)};let U,F,L,v,z,S,X,j,t=!1;const r=o=>{const{touches:n}=o;if(U=n.length,U===2&&e.disableZoom)return;const{offsetX:c}=m;m.start(o),F=a.moveX,L=a.moveY,j=Date.now(),t=!1,a.moving=U===1&&(a.scale!==1||y.value),a.zooming=U===2&&!c.value,a.zooming&&(v=a.scale,z=de(n))},I=o=>{const{touches:n}=o;if(m.move(o),a.moving){const{deltaX:c,deltaY:P}=m,O=c.value+F,A=P.value+L;if((e.vertical?m.isVertical()&&Math.abs(A)>g.value:m.isHorizontal()&&Math.abs(O)>f.value)&&!t){a.moving=!1;return}t=!0,ae(o,!0),a.moveX=Y(O,-f.value,f.value),a.moveY=Y(A,-g.value,g.value)}if(a.zooming&&(ae(o,!0),n.length===2)){const c=de(n),P=v*c/z;S=Ne(n),h(P,S)}},w=o=>{var n;const c=(n=k.value)==null?void 0:n.$el;if(!c)return;const P=c.firstElementChild,O=o.target===c,A=P?.contains(o.target);!e.closeOnClickImage&&A||!e.closeOnClickOverlay&&O||l("close")},T=o=>{if(U>1)return;const n=Date.now()-j,c=250;m.isTap.value&&(n<c?e.doubleScale?X?(clearTimeout(X),X=null,$()):X=setTimeout(()=>{w(o),X=null},c):w(o):n>pe&&l("longPress"))},D=o=>{let n=!1;if((a.moving||a.zooming)&&(n=!0,a.moving&&F===a.moveX&&L===a.moveY&&(n=!1),!o.touches.length)){a.zooming&&(a.moveX=Y(a.moveX,-f.value,f.value),a.moveY=Y(a.moveY,-g.value,g.value),a.zooming=!1),a.moving=!1,F=0,L=0,v=1,a.scale<1&&x();const c=+e.maxZoom;a.scale>c&&h(c,S)}ae(o,n),T(o),m.reset()},q=()=>{const{rootWidth:o,rootHeight:n}=e,c=n/o,{imageRatio:P}=a;C.value=a.imageRatio>c&&P<ve,y.value=a.imageRatio>c&&P>=ve,y.value&&(R=(P*o-n)/2,a.moveY=R,a.initializing=!0,Oe(()=>{a.initializing=!1})),x()},H=o=>{const{naturalWidth:n,naturalHeight:c}=o.target;a.imageRatio=c/n,q()};return V(()=>e.active,x),V(()=>e.show,o=>{o||x()}),V(()=>[e.rootWidth,e.rootHeight],q),ze("touchmove",I,{target:K(()=>{var o;return(o=k.value)==null?void 0:o.$el})}),se({resetScale:x}),()=>{const o={loading:()=>i(Pe,{type:"spinner"},null)};return i(Ee,{ref:k,class:oe("swipe-item"),onTouchstartPassive:r,onTouchend:D,onTouchcancel:D},{default:()=>[u.image?i("div",{class:oe("image-wrap")},[u.image({src:e.src,onLoad:H,style:s.value})]):i(Ie,{ref:d,src:e.src,fit:"contain",class:oe("image",{vertical:C.value}),style:s.value,onLoad:H},o)]})}}});const[qe,Z]=ne("image-preview"),Ge=["show","teleport","transition","overlayStyle","closeOnPopstate"],Ke={show:Boolean,loop:p,images:ge(),minZoom:E(1/3),maxZoom:E(3),overlay:p,vertical:Boolean,closeable:Boolean,showIndex:p,className:re,closeIcon:M("clear"),transition:String,beforeClose:Function,doubleScale:p,overlayClass:re,overlayStyle:Object,swipeDuration:E(300),startPosition:E(0),showIndicators:Boolean,closeOnPopstate:p,closeOnClickImage:p,closeOnClickOverlay:p,closeIconPosition:M("top-right"),teleport:[String,Object]};var Se=ee({name:qe,props:Ke,emits:["scale","close","closed","change","longPress","update:show"],setup(e,{emit:l,slots:u}){const a=B(),m=B(),d=le({active:0,rootWidth:0,rootHeight:0,disableZoom:!1}),k=()=>{if(a.value){const v=fe(a.value.$el);d.rootWidth=v.width,d.rootHeight=v.height,a.value.resize()}},C=v=>l("scale",v),y=v=>l("update:show",v),R=()=>{we(e.beforeClose,{args:[d.active],done:()=>y(!1)})},s=v=>{v!==d.active&&(d.active=v,l("change",v))},f=()=>{if(e.showIndex)return i("div",{class:Z("index")},[u.index?u.index({index:d.active}):`${d.active+1} / ${e.images.length}`])},g=()=>{if(u.cover)return i("div",{class:Z("cover")},[u.cover()])},h=()=>{d.disableZoom=!0},x=()=>{d.disableZoom=!1},$=()=>i($e,{ref:a,lazyRender:!0,loop:e.loop,class:Z("swipe"),vertical:e.vertical,duration:e.swipeDuration,initialSwipe:e.startPosition,showIndicators:e.showIndicators,indicatorColor:"white",onChange:s,onDragEnd:x,onDragStart:h},{default:()=>[e.images.map((v,z)=>i(We,{ref:S=>{z===d.active&&(m.value=S)},src:v,show:e.show,active:d.active,maxZoom:e.maxZoom,minZoom:e.minZoom,rootWidth:d.rootWidth,rootHeight:d.rootHeight,disableZoom:d.disableZoom,doubleScale:e.doubleScale,closeOnClickImage:e.closeOnClickImage,closeOnClickOverlay:e.closeOnClickOverlay,vertical:e.vertical,onScale:C,onClose:R,onLongPress:()=>l("longPress",{index:z})},{image:u.image}))]}),U=()=>{if(e.closeable)return i(W,{role:"button",name:e.closeIcon,class:[Z("close-icon",e.closeIconPosition),Fe],onClick:R},null)},F=()=>l("closed"),L=(v,z)=>{var S;return(S=a.value)==null?void 0:S.swipeTo(v,z)};return se({resetScale:()=>{var v;(v=m.value)==null||v.resetScale()},swipeTo:L}),Te(k),V([De,Ue],k),V(()=>e.startPosition,v=>s(+v)),V(()=>e.show,v=>{const{images:z,startPosition:S}=e;v?(s(+S),he(()=>{k(),L(+S,{immediate:!0})})):l("close",{index:d.active,url:z[d.active]})}),()=>i(Ve,ie({class:[Z(),e.className],overlayClass:[Z("overlay"),e.overlayClass],onClosed:F,"onUpdate:show":y},_(e,Ge)),{default:()=>[U(),$(),f(),g()]})}});let Q;const Qe={loop:!0,images:[],maxZoom:3,minZoom:1/3,onScale:void 0,onClose:void 0,onChange:void 0,vertical:!1,teleport:"body",className:"",showIndex:!0,closeable:!1,closeIcon:"clear",transition:void 0,beforeClose:void 0,doubleScale:!0,overlayStyle:void 0,overlayClass:void 0,startPosition:0,swipeDuration:300,showIndicators:!1,closeOnPopstate:!0,closeOnClickOverlay:!0,closeIconPosition:"top-right"};function Je(){({instance:Q}=je({setup(){const{state:e,toggle:l}=He(),u=()=>{e.images=[]};return()=>i(Se,ie(e,{onClosed:u,"onUpdate:show":l}),null)}}))}const ea=(e,l=0)=>{if(Le)return Q||Je(),e=Array.isArray(e)?{images:e,startPosition:l}:e,Q.open(J({},Qe,e)),Q};be(Se);const[aa,b,oa]=ne("uploader");function me(e,l){return new Promise(u=>{if(l==="file"){u();return}const a=new FileReader;a.onload=m=>{u(m.target.result)},l==="dataUrl"?a.readAsDataURL(e):l==="text"&&a.readAsText(e)})}function ke(e,l){return ye(e).some(u=>u.file?Ae(l)?l(u.file):u.file.size>+l:!1)}function ta(e,l){const u=[],a=[];return e.forEach(m=>{ke(m,l)?a.push(m):u.push(m)}),{valid:u,invalid:a}}const la=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|avif)/i,na=e=>la.test(e);function xe(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?na(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var ia=ee({props:{name:te,item:N(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,reupload:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview","reupload"],setup(e,{emit:l,slots:u}){const a=()=>{const{status:s,message:f}=e.item;if(s==="uploading"||s==="failed"){const g=s==="failed"?i(W,{name:"close",class:b("mask-icon")},null):i(Pe,{class:b("loading")},null),h=Be(f)&&f!=="";return i("div",{class:b("mask")},[g,h&&i("div",{class:b("mask-message")},[f])])}},m=s=>{const{name:f,item:g,index:h,beforeDelete:x}=e;s.stopPropagation(),we(x,{args:[g,{name:f,index:h}],done:()=>l("delete")})},d=()=>l("preview"),k=()=>l("reupload"),C=()=>{if(e.deletable&&e.item.status!=="uploading"){const s=u["preview-delete"];return i("div",{role:"button",class:b("preview-delete",{shadow:!s}),tabindex:0,"aria-label":oa("delete"),onClick:m},[s?s():i(W,{name:"cross",class:b("preview-delete-icon")},null)])}},y=()=>{if(u["preview-cover"]){const{index:s,item:f}=e;return i("div",{class:b("preview-cover")},[u["preview-cover"](J({index:s},f))])}},R=()=>{const{item:s,lazyLoad:f,imageFit:g,previewSize:h,reupload:x}=e;return xe(s)?i(Ie,{fit:g,src:s.objectUrl||s.content||s.url,class:b("preview-image"),width:Array.isArray(h)?h[0]:h,height:Array.isArray(h)?h[1]:h,lazyLoad:f,onClick:x?k:d},{default:y}):i("div",{class:b("file"),style:Ce(e.previewSize)},[i(W,{class:b("file-icon"),name:"description"},null),i("div",{class:[b("file-name"),"van-ellipsis"]},[s.file?s.file.name:s.url]),y()])};return()=>i("div",{class:b("preview")},[R(),a(),C()])}});const sa={name:E(""),accept:M("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:E(1/0),imageFit:M("cover"),resultType:M("dataUrl"),uploadIcon:M("photograph"),uploadText:String,deletable:p,reupload:Boolean,afterRead:Function,showUpload:p,modelValue:ge(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:p,previewOptions:Object,previewFullImage:p,maxSize:{type:[Number,String,Function],default:1/0}};var ra=ee({name:aa,props:sa,emits:["delete","oversize","clickUpload","closePreview","clickPreview","clickReupload","update:modelValue"],setup(e,{emit:l,slots:u}){const a=B(),m=[],d=B(-1),k=B(!1),C=(t=e.modelValue.length)=>({name:e.name,index:t}),y=()=>{a.value&&(a.value.value="")},R=t=>{if(y(),ke(t,e.maxSize))if(Array.isArray(t)){const r=ta(t,e.maxSize);if(t=r.valid,l("oversize",r.invalid,C()),!t.length)return}else{l("oversize",t,C());return}if(t=le(t),d.value>-1){const r=[...e.modelValue];r.splice(d.value,1,t),l("update:modelValue",r),d.value=-1}else l("update:modelValue",[...e.modelValue,...ye(t)]);e.afterRead&&e.afterRead(t,C())},s=t=>{const{maxCount:r,modelValue:I,resultType:w}=e;if(Array.isArray(t)){const T=+r-I.length;t.length>T&&(t=t.slice(0,T)),Promise.all(t.map(D=>me(D,w))).then(D=>{const q=t.map((H,o)=>{const n={file:H,status:"",message:"",objectUrl:URL.createObjectURL(H)};return D[o]&&(n.content=D[o]),n});R(q)})}else me(t,w).then(T=>{const D={file:t,status:"",message:"",objectUrl:URL.createObjectURL(t)};T&&(D.content=T),R(D)})},f=t=>{const{files:r}=t.target;if(e.disabled||!r||!r.length)return;const I=r.length===1?r[0]:[].slice.call(r);if(e.beforeRead){const w=e.beforeRead(I,C());if(!w){y();return}if(Ze(w)){w.then(T=>{s(T||I)}).catch(y);return}}s(I)};let g;const h=()=>l("closePreview"),x=t=>{if(e.previewFullImage){const r=e.modelValue.filter(xe),I=r.map(w=>(w.objectUrl&&!w.url&&w.status!=="failed"&&(w.url=w.objectUrl,m.push(w.url)),w.url)).filter(Boolean);g=ea(J({images:I,startPosition:r.indexOf(t),onClose:h},e.previewOptions))}},$=()=>{g&&g.close()},U=(t,r)=>{const I=e.modelValue.slice(0);I.splice(r,1),l("update:modelValue",I),l("delete",t,C(r))},F=t=>{k.value=!0,d.value=t,he(()=>j())},L=()=>{k.value||(d.value=-1),k.value=!1},v=(t,r)=>{const I=["imageFit","deletable","reupload","previewSize","beforeDelete"],w=J(_(e,I),_(t,I,!0));return i(ia,ie({item:t,index:r,onClick:()=>l(e.reupload?"clickReupload":"clickPreview",t,C(r)),onDelete:()=>U(t,r),onPreview:()=>x(t),onReupload:()=>F(r)},_(e,["name","lazyLoad"]),w),_(u,["preview-cover","preview-delete"]))},z=()=>{if(e.previewImage)return e.modelValue.map(v)},S=t=>l("clickUpload",t),X=()=>{const t=e.modelValue.length<+e.maxCount,r=e.readonly?null:i("input",{ref:a,type:"file",class:b("input"),accept:e.accept,capture:e.capture,multiple:e.multiple&&d.value===-1,disabled:e.disabled,onChange:f,onClick:L},null);return u.default?ce(i("div",{class:b("input-wrapper"),onClick:S},[u.default(),r]),[[ue,t]]):ce(i("div",{class:b("upload",{readonly:e.readonly}),style:Ce(e.previewSize),onClick:S},[i(W,{name:e.uploadIcon,class:b("upload-icon")},null),e.uploadText&&i("span",{class:b("upload-text")},[e.uploadText]),r]),[[ue,e.showUpload&&t]])},j=()=>{a.value&&!e.disabled&&a.value.click()};return Xe(()=>{m.forEach(t=>URL.revokeObjectURL(t))}),se({chooseFile:j,reuploadFile:F,closeImagePreview:$}),Ye(()=>e.modelValue),()=>i("div",{class:b()},[i("div",{class:b("wrapper",{disabled:e.disabled})},[z(),X()])])}});const ma=be(ra);export{ma as U};
